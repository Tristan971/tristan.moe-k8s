loki:
  persistence:
    enabled: true
    existingClaim: loki-data

promtail:
  extraScrapeConfigs:
    - job_name: mdah-timings
      pipeline_stages:
        - match:
            selector: '{app="mangadex-at-home"} |= "TTFB"'
            stages:
              - regex:
                  expression: (?P<timestamp>) INFO.*completed \(TTFB\) in (?P<exec_ms>[\d]+)ms
              - timestamp:
                  format: yyyy-mm-dd hh:mm:ss
                  source: timestamp
              - metrics:
                  ttfb_ms:
                    config:
                      action: add
                    description: "TTFB of served images"
                    source: exec_ms
                    type: Gauge
      kubernetes_sd_configs:
        - role: pod
      relabel_configs:
        - source_labels:
            - __meta_kubernetes_pod_label_name
          target_label: __service__
        - source_labels:
            - __meta_kubernetes_pod_node_name
          target_label: __host__
        - action: drop
          regex: ''
          source_labels:
            - __service__
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        - action: replace
          replacement: $1
          separator: /
          source_labels:
            - __meta_kubernetes_namespace
            - __service__
          target_label: job
        - action: replace
          source_labels:
            - __meta_kubernetes_namespace
          target_label: namespace
        - action: replace
          source_labels:
            - __meta_kubernetes_pod_name
          target_label: pod
        - action: replace
          source_labels:
            - __meta_kubernetes_pod_container_name
          target_label: container
        - replacement: /var/log/pods/*$1/*.log
          separator: /
          source_labels:
            - __meta_kubernetes_pod_uid
            - __meta_kubernetes_pod_container_name
          target_label: __path__
